
## 为什么要文本分块？

文本分块（Chunking）主要是为了解决大模型处理长文本时面临的两个核心问题：​**模型自身的上下文限制**和**提升检索效率与精度**。

| 分块原因          | 具体说明                                                | 主要影响或益处                            |
| ------------- | --------------------------------------------------- | ---------------------------------- |
| ​**模型上下文限制**​ | 大模型有固定的上下文窗口（如4K-200K tokens），超长文本需分块处理以避免信息被截断。    | 确保长文本内容能被模型完整处理和记忆，避免遗漏开头或中间的关键信息。 |
| ​**计算资源优化**​  | 注意力机制的计算复杂度与文本长度平方成正比（O(n²)），分块可显著降低计算负担和显存占用。      | 提高处理效率，降低硬件成本。                     |
| ​**提升检索精度**​  | 过大文本块可能包含多个无关主题，导致检索时引入噪音。分块使每个小块聚焦单一语义，便于精准匹配查询意图。 | 增强向量检索的准确性，使模型能快速定位最相关信息，减少冗余信息干扰。 |
| ​**保持语义一致性**​ | 无脑分块可能破坏句子、段落或实体的完整性。合理的分块策略（如重叠分块、语义分块）能维护上下文连贯性。  | 提升模型对文本的理解质量，生成更准确、连贯的回答。          |
## 分块多大适合，有什么影响？

首先你要知道模型最长能接受的上下文，一些老模型如Bert就是不能超过512个字节。

分块的大小，会直接影响对检索精度的影响

这问题，并不是简单块越大，或越小就好，而是需要在这个文本嵌入的生成过程中，也就是文本被变成嵌入向量的这个过程中，他到底发生了什么。

我们大多数的嵌入模型，都是基于transform编码器的这个模型来处理的，输入的文本就会被压缩为一个固定维度的，单一的向量。

比如例子768维的向量，那么，这个输入的文本就会被分词，然后在这文本块儿之前就是这个chunk，之前就加一个cls就分类标签儿。

然后transformer会对每一个token生成对应的向量表示。

接下来就要做磁化（你就可以把它视为一种压缩），然后把所有的这个token级别的向量压缩成单个向量。

所以实际上你最后你所得到的是针对于你的这个chunk，也就是对于你这个文本块儿。得到了一个特定维度的，一个单一的文本嵌入向量，也就是768维。

在这个过程中，从每一个token拥有一个768维的向量。

到最后你整个的这一大段儿的文本块儿，共享成一个768维的最终的单一向量。它这个过程中是存在有信息损失的。那么这个。信息损失。

也就是说，如果你用这一个768维的向量去代表一个非常非常长的一段儿话。那么其实他的。信息损失是越大还是越小？可想而知，你的块儿越大越长，你实际上这768维的向量所代表的。那个信息损失其实也就越大啊，无论你是通过这个cls做铺领，还是做这个。

min pulling也就是对所有向量求平均还是做max pulling，就是选择每一个token里边的最大的那个值做这个。平均它都会产生。损失。因此啊，就是说啊，我们了解了这个transformer，它对于每个token向量化的过程，然后再把这个所有的token。啊，给它压缩成最后一个代表，你这段儿文本的唯一向量的这个过程呢？实际上你就理解了，对于比较大的块儿，向量它的表示可能会过于笼统。

它的精度就降低了，那么某些关键的细节也就被模糊化了。所以说我们并不应该。选择这个嵌入模型所能够接纳的最大的token数啊，你说你强，你能够接8000个，我就每一个啊都给你切成8000个。这样是啊，不合适的还是应该按照这个啊，合适的大小包括语义的一个。考量去。确定你的块儿的大小不宜太长，当然也不宜太短，为什么呢啊？咱们就接着讲。

作业：

使用Unstructured基于文档结构分块
概述
基于对文档语义结构的识别进行分块，而非简单地根据空行或换行符拆分文本。

分块策略
Basic策略
- 将文本元素顺序合并到同一分块，直到达到：
  - **最大字符数**（max characters）
  - **软字符限制**（new after n chars）
- 超大元素（如长文本、大表格）超过最大字符数时会进行二次拆分
- 表格元素作为独立分块处理；过大表格会拆分为多个`TableChunk`
- 可选参数：
  - `overlap`：设置分块重叠
  - `overlap_all`：设置全部分块重叠

By Title策略
- 保留Basic策略的基础行为
- 检测到**新标题**（Title元素）时立即关闭当前分块并开启新分块
- 可选参数：
  - `multipage_sections`：控制跨页片段的合并或拆分
  - `combine_text_under_n_chars`：合并短小片段


API专用策略
- By Page
	- 确保**每页的内容独立分块**

- By Similarity
	- 利用**嵌入模型**将主题相似的元素组合成块

## 与分块相关的高级索引技巧

带滑动窗口的句子切分（Sliding Windows）


分块时混合生成父子文本块（Parent-Child Docs）


分块时为文本块创建元数据


分块时形成有级别的索引（Summary->Details）


文档->嵌入对象（Document->Embedded Objects）